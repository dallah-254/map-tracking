<!DOCTYPE html>
<html>
<head>
    <title>Rider Pro - Live Navigation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #1a1a1a; }
        .sidebar { width: 320px; background: #232f3e; color: white; display: flex; flex-direction: column; border-right: 2px solid #ff9900; }
        .sidebar-header { padding: 20px; background: #131921; text-align: center; }
        .sidebar-content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        #map { flex: 1; height: 100vh; }
        .btn { padding: 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.2s; width: 100%; }
        .btn-fetch { background: #37475a; color: white; }
        .btn-link { background: #ff9900; color: white; margin-top: 10px; }
        .btn-go-live { background: #00a8e1; color: white; display: none; }
        .btn-stop { background: #cc0000; color: white; display: none; }
        .order-card { background: white; color: #333; padding: 12px; border-radius: 6px; margin-top: 10px; border-left: 5px solid #ff9900; }
        .status-dot { height: 10px; width: 10px; background-color: #555; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-active { background-color: #00ff00; box-shadow: 0 0 8px #00ff00; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h2 style="color: #ff9900; margin: 0;">RIDER PRO</h2>
        <div style="margin-top: 10px; font-size: 13px;">
            <span id="dot" class="status-dot"></span> <span id="status-text">OFFLINE</span>
        </div>
    </div>
    
    <div class="sidebar-content">
        <button id="fetchBtn" class="btn btn-fetch" onclick="fetchOrders()">üîç GET AVAILABLE ORDERS</button>
        <div id="order-list"></div>
        
        <hr style="border: 0.5px solid #37475a; margin: 10px 0;">
        
        <button id="goLiveBtn" class="btn btn-go-live" onclick="startBroadcast()">üì° GO LIVE (START TRACKING)</button>
        <button id="stopLiveBtn" class="btn btn-stop" onclick="stopBroadcast()">üõë STOP TRACKING</button>
    </div>
</div>

<div id="map"></div>

<script>
    const CONFIG = {
        apiKey: "v1.public.eyJqdGkiOiI5ODhmMzBiNi1hYWFjLTRlMmEtOTY0My0wYTgwMmRlZGM1MDkifYr1nFD6LeDRmEuYwAHCT1BCu-cwEaqnjVJ53ocPhRObx9Tk85tar2QpErtuPLdSfruFMMSoMYHxvnKVdCVpZDjSqGpsFGf97OXfY9qmQypPo9DOQOWlMcVWjLB2vOf94Rubo-fV1-11zGEcyaYyORTjBjfKBqOqyGb7aM_96BvTwnGIoJADgbtcqW1BtupSRTdxCv3PZYOKX-J2InUhT70c_jU5zWjui8XsFD1CzKeA-My0Bm-0hWho55XMB0sOdg9lmtAsOi0g6Kdsh4avm_a1jqm5ZF4qU3PevoFe_wYinkF-eNkW9kQIKRDpzKNmQcAYUB2fzr8ijnXShy7pZV8.ZWU0ZWIzMTktMWRhNi00Mzg0LTllMzYtNzlmMDU3MjRmYTkx",
        region: "us-east-1",
        apiUrl: "https://2xtdrxfglh.execute-api.us-east-1.amazonaws.com"
    };

    const map = new maplibregl.Map({
        container: 'map',
        style: `https://maps.geo.${CONFIG.region}.amazonaws.com/v2/styles/Standard/descriptor?key=${CONFIG.apiKey}`,
        center: [36.8219, -1.2921],
        zoom: 13
    });

    const riderMarker = new maplibregl.Marker({ color: "#ff9900" }).setLngLat([36.8219, -1.2921]).addTo(map);
    let pickupMarker, dropoffMarker;
    let watchId = null;
    let activeOrderId = "STANDBY";

    async function fetchOrders() {
        const list = document.getElementById('order-list');
        list.innerHTML = "<p>Loading...</p>";
        try {
            const res = await fetch(`${CONFIG.apiUrl}/rider/orders?role=rider`);
            const orders = await res.json();
            list.innerHTML = "";
            orders.forEach(order => {
                const card = document.createElement('div');
                card.className = 'order-card';
                card.innerHTML = `
                    <strong>Order #${order.OrderId.slice(-5)}</strong><br>
                    <span>Price: KES ${order.Price}</span><br>
                    <button class="btn btn-link" onclick="linkThisOrder('${order.OrderId}', ${JSON.stringify(order.Origin)}, ${JSON.stringify(order.Destination)})">LINK & VIEW ROUTE</button>
                `;
                list.appendChild(card);
            });
        } catch (e) { list.innerHTML = "Error fetching orders."; }
    }

    async function linkThisOrder(orderId, origin, destination) {
        // 1. Update status in DB via the Universal Lambda
        try {
            const res = await fetch(`${CONFIG.apiUrl}/rider/orders`, {
                method: 'POST',
                body: JSON.stringify({ orderId: orderId, riderId: "RIDER_01" })
            });
            
            if (res.ok) {
                activeOrderId = orderId;
                alert("Linked! Now showing Pickup and Drop-off.");
                
                // 2. Show coordinates on map
                if (pickupMarker) pickupMarker.remove();
                if (dropoffMarker) dropoffMarker.remove();

                pickupMarker = new maplibregl.Marker({ color: "#28a745" }).setLngLat(origin).addTo(map);
                dropoffMarker = new maplibregl.Marker({ color: "#dc3545" }).setLngLat(destination).addTo(map);
                
                // 3. Adjust UI
                document.getElementById('status-text').innerText = "LINKED: #" + orderId.slice(-5);
                document.getElementById('goLiveBtn').style.display = 'block';
                document.getElementById('order-list').innerHTML = "<p style='color:lime'>Order Accepted!</p>";

                // Zoom to fit the route
                const bounds = new maplibregl.LngLatBounds().extend(origin).extend(destination);
                map.fitBounds(bounds, { padding: 50 });
            }
        } catch (e) { alert("Error linking order."); }
    }

    function startBroadcast() {
        if (!navigator.geolocation) return alert("Enable GPS");
        
        document.getElementById('goLiveBtn').style.display = 'none';
        document.getElementById('stopLiveBtn').style.display = 'block';
        document.getElementById('dot').classList.add('status-active');
        document.getElementById('status-text').innerText = "LIVE & BROADCASTING";

        watchId = navigator.geolocation.watchPosition(async (pos) => {
            const { longitude, latitude } = pos.coords;
            
            // Move marker on rider map
            riderMarker.setLngLat([longitude, latitude]);

            // BROADCAST TO DB
            try {
                const response = await fetch(`${CONFIG.apiUrl}/rider/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: activeOrderId,
                        riderId: "RIDER_01",
                        lng: longitude,
                        lat: latitude
                    })
                });
                console.log("Broadcast status:", response.status);
            } catch (err) {
                console.error("Broadcast failed:", err);
            }
        }, (err) => console.error(err), { enableHighAccuracy: true });
    }

    function stopBroadcast() {
        if (watchId) navigator.geolocation.clearWatch(watchId);
        location.reload(); 
    }
</script>
</body>
</html>