<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rider Dashboard - Delivery System</title>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f8f9fa;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 280px;
            z-index: 1000;
        }

        .map-controls h3 {
            color: #1a73e8;
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .legend-color.you {
            background: #667eea;
            border: 2px solid #5a67d8;
        }

        .legend-color.pickup {
            background: #28a745;
            border: 2px solid #218838;
        }

        .legend-color.dropoff {
            background: #dc3545;
            border: 2px solid #c82333;
        }

        .legend-color.route {
            width: 30px;
            height: 4px;
            background: #667eea;
            border-radius: 2px;
        }

        /* Sidebar */
        .sidebar {
            width: 450px;
            background: white;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* Rider Info Card */
        .rider-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #eaeaea;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .rider-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            border: 3px solid rgba(255,255,255,0.3);
        }

        .rider-details {
            flex: 1;
        }

        .rider-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-busy {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-online .status-dot {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-offline .status-dot {
            background: #dc3545;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Section Styles */
        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #eaeaea;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-header h2 {
            color: #333;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: #5f6368;
            font-weight: 500;
            font-size: 0.9rem;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            gap: 8px;
            width: 100%;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-group-horizontal {
            display: flex;
            gap: 10px;
        }

        .btn-group-horizontal .btn {
            flex: 1;
        }

        /* Tracking Controls */
        .tracking-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tracking-btn {
            padding: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tracking-btn.active {
            background: #667eea;
            color: white;
        }

        .tracking-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        /* Orders List */
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 450px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .order-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 16px;
            transition: all 0.2s;
        }

        .order-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .order-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #667eea;
            font-size: 0.9rem;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .order-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: #ffc107;
            color: #000;
            text-transform: uppercase;
        }

        .order-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .detail-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .detail-item h4 {
            color: #6c757d;
            font-size: 0.7rem;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item p {
            font-weight: 500;
            color: #212529;
            font-size: 0.9rem;
            word-break: break-word;
        }

        /* Current Order */
        .current-order-section {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .current-order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .current-order-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #155724;
            background: #c3e6cb;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .current-order-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }

        .current-detail-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #c3e6cb;
        }

        .current-detail-item h4 {
            color: #155724;
            font-size: 0.75rem;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .current-detail-item p {
            font-weight: 600;
            color: #155724;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
        }

        .empty-state p {
            margin-top: 10px;
            font-size: 0.9rem;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-success { background: #28a745; }
        .toast-error { background: #dc3545; }
        .toast-info { background: #17a2b8; }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { width: 400px; }
        }

        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: 50vh; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <h3>üìç Map Legend</h3>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color you"></div>
                        <span>Your Location</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color pickup"></div>
                        <span>Pickup Location</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color dropoff"></div>
                        <span>Dropoff Location</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color route"></div>
                        <span>Route</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>üö¥ Rider Dashboard</h1>
                <p style="opacity: 0.9; margin-top: 5px;">Accept deliveries and track your route</p>
            </div>

            <div class="sidebar-content">
                <!-- Rider Profile Card -->
                <div class="rider-card">
                    <div class="rider-avatar" id="riderAvatar">R</div>
                    <div class="rider-details">
                        <div class="rider-name" id="riderName">Not Logged In</div>
                        <div>
                            <span id="riderStatusBadge" class="status-badge status-offline">
                                <span class="status-dot"></span>
                                <span>Offline</span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Rider ID Setup -->
                <div class="section">
                    <h2 style="margin-bottom: 15px;">üîê Rider Authentication</h2>
                    <div class="form-group">
                        <label for="riderId">Your Rider ID</label>
                        <input type="text" id="riderId" placeholder="Enter your rider ID" value="RIDER-001">
                    </div>
                    <div class="btn-group-horizontal">
                        <button class="btn btn-success" onclick="setRiderId()" id="setRiderBtn" style="flex: 2;">
                            ‚úÖ Set Rider ID
                        </button>
                        <button class="btn btn-primary" onclick="fetchAvailableOrders()" id="fetchOrdersBtn" style="flex: 1;">
                            üîÑ Fetch
                        </button>
                    </div>
                </div>

                <!-- Tracking Controls -->
                <div class="section">
                    <h2 style="margin-bottom: 15px;">üì° Location Tracking</h2>
                    <div class="tracking-controls">
                        <button class="tracking-btn" onclick="toggleTracking()" id="trackingBtn">
                            <span>üì°</span> Go Online
                        </button>
                        <button class="tracking-btn" onclick="centerOnLocation()">
                            <span>üìç</span> Center Map
                        </button>
                    </div>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-top: 10px;">
                        <p style="font-size: 0.85rem; color: #6c757d; display: flex; align-items: center; gap: 8px;">
                            <span id="trackingStatusIndicator" style="width: 8px; height: 8px; background: #dc3545; border-radius: 50%; display: inline-block;"></span>
                            <span id="trackingStatusText">Status: Offline</span>
                        </p>
                    </div>
                </div>

                <!-- Available Orders Section -->
                <div class="section">
                    <div class="section-header">
                        <h2>
                            <span>üì¶</span> Available Orders
                        </h2>
                        <button onclick="fetchAvailableOrders()" id="refreshOrdersBtn" class="btn btn-primary" style="width: auto; padding: 8px 16px;">
                            üîÑ Refresh
                        </button>
                    </div>
                    
                    <div id="ordersList" class="orders-list">
                        <div class="empty-state">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üì≠</div>
                            <p>No orders available</p>
                            <p style="font-size: 0.8rem; margin-top: 5px;">Click Fetch or Refresh to load orders</p>
                        </div>
                    </div>
                </div>

                <!-- Current Order Section - HIDDEN by default -->
                <div id="currentOrderContainer" style="display: none;">
                    <div class="current-order-section">
                        <div class="current-order-header">
                            <div>
                                <span class="current-order-id" id="currentOrderIdDisplay">ORD-12345</span>
                            </div>
                            <span class="status-badge status-busy" id="currentOrderStatusBadge">
                                <span class="status-dot"></span>
                                <span>Assigned</span>
                            </span>
                        </div>
                        
                        <div id="currentOrderDetails">
                            <!-- Populated by JavaScript -->
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="updateOrderStatus('picked_up')" id="pickupBtn" class="btn btn-success" style="flex: 1;">
                                üì¶ Picked Up
                            </button>
                            <button onclick="updateOrderStatus('delivered')" id="deliverBtn" class="btn btn-success" style="flex: 1; display: none;">
                                ‚úÖ Delivered
                            </button>
                            <button onclick="cancelOrder()" class="btn btn-secondary" style="flex: 1; background: #6c757d;">
                                ‚ùå Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Load MapLibre -->
    <script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>
    
    <script>
        // ==================== CONFIGURATION ====================
        const MAP_API_KEY = 'v1.public.eyJqdGkiOiJjOWEwNmRmNi0wODgxLTQzM2QtOGMwNi05ZjhmNjVhYTRhMzYifSrvVxxGFJECbaRbhiVx2asiZPsR35Nk1OvudGlWz23aZiLfNXXypiMori-FaCLerKmpUJD7JH9Z6gEBa79sJRSSU7Sccfpj9Ecg5jzqFbIeCRaFtU2T2DlpPfjAc9ijqXYiFReqoAUpXBMsBGvfYJO2f4xjaLJRJnvoEEYyTHxDH2ybm6xZcLy1x7LqtvBMrIVxTXSLH1lcmVPFUAfKXyE1mRpbhF4Nz_hKSgUzVeCgDV4pEKG1JRZWUtvfHXkY34noR_3MD5uH6uEbrMy5IsTkuRLE_AsRQGr8ihDsC42r9czqp4lWobrXdGXFRPqswkscF66yB45y1wdslhsS-_8.NjAyMWJkZWUtMGMyOS00NmRkLThjZTMtODEyOTkzZTUyMTBi';
        const API_BASE_URL = 'https://kpafwhlv70.execute-api.us-east-2.amazonaws.com/prod';
        
        // ==================== GLOBAL VARIABLES ====================
        let map;
        let riderMarker = null;
        let pickupMarker = null;
        let dropoffMarker = null;
        let routeLayer = null;
        
        let riderId = '';
        let currentOrder = null;
        let isTracking = false;
        let currentLocation = null;
        let locationWatchId = null;

        // ==================== INITIALIZATION ====================
        window.onload = function() {
            initMap();
            generateRiderId();
        };

        function generateRiderId() {
            riderId = 'RIDER-' + Math.random().toString(36).substr(2, 8).toUpperCase();
            document.getElementById('riderId').value = riderId;
            document.getElementById('riderName').textContent = 'Rider ' + riderId.substr(-4);
            document.getElementById('riderAvatar').textContent = riderId.charAt(0);
        }

        function setRiderId() {
            const input = document.getElementById('riderId').value.trim();
            if (input) {
                riderId = input;
                document.getElementById('riderName').textContent = 'Rider ' + riderId.substr(-4);
                document.getElementById('riderAvatar').textContent = riderId.charAt(0);
                showToast(`Rider ID set to: ${riderId}`, 'success');
                fetchAvailableOrders(); // Auto-fetch orders after setting ID
            } else {
                showToast('Please enter a Rider ID', 'error');
            }
        }

        // ==================== MAP INITIALIZATION ====================
        async function initMap() {
            try {
                map = new maplibregl.Map({
                    container: 'map',
                    style: `https://maps.geo.us-east-2.amazonaws.com/maps/v0/maps/NextGen/style-descriptor?key=${MAP_API_KEY}`,
                    center: [36.8219, -1.2921],
                    zoom: 12,
                    transformRequest: (url) => {
                        if (url.includes('amazonaws.com')) {
                            return {
                                url: url.includes('?') ? 
                                    `${url}&key=${MAP_API_KEY}` : 
                                    `${url}?key=${MAP_API_KEY}`
                            };
                        }
                        return { url };
                    }
                });

                map.addControl(new maplibregl.NavigationControl(), 'top-right');

                map.on('load', () => {
                    console.log('Map loaded successfully');
                    getCurrentLocation();
                });

            } catch (error) {
                console.error('Map initialization error:', error);
                showToast('Failed to load map', 'error');
            }
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        currentLocation = { latitude, longitude };
                        map.setCenter([longitude, latitude]);
                        map.setZoom(15);
                        addRiderMarker(latitude, longitude);
                    },
                    (error) => {
                        console.warn('Geolocation error:', error.message);
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            }
        }

        function addRiderMarker(lat, lng) {
            if (riderMarker) riderMarker.remove();
            
            const el = document.createElement('div');
            el.style.width = '40px';
            el.style.height = '40px';
            el.style.background = '#667eea';
            el.style.borderRadius = '50%';
            el.style.border = '3px solid white';
            el.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
            el.style.display = 'flex';
            el.style.alignItems = 'center';
            el.style.justifyContent = 'center';
            el.style.color = 'white';
            el.style.fontSize = '20px';
            el.innerHTML = 'üö¥';
            
            riderMarker = new maplibregl.Marker({ element: el })
                .setLngLat([lng, lat])
                .setPopup(new maplibregl.Popup().setHTML('<b>Your Location</b>'))
                .addTo(map);
        }

        // ==================== FETCH ORDERS - THIS IS THE FIX ====================
        // Using the same endpoint as client: GET /orders
        async function fetchAvailableOrders() {
            if (!riderId) {
                showToast('Please set your Rider ID first', 'error');
                return;
            }

            // Show spinner on refresh button
            const refreshBtn = document.getElementById('refreshOrdersBtn');
            const fetchBtn = document.getElementById('fetchOrdersBtn');
            
            if (refreshBtn) {
                refreshBtn.innerHTML = '<span class="btn-spinner"></span> Loading...';
                refreshBtn.disabled = true;
            }
            if (fetchBtn) {
                fetchBtn.innerHTML = '<span class="btn-spinner"></span> Fetching...';
                fetchBtn.disabled = true;
            }

            try {
                // Use the SAME endpoint as client: /orders
                const response = await fetch(`${API_BASE_URL}/orders`, {
                    method: 'GET',
                    headers: { 
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Orders fetched:', data);
                
                // Extract orders array - handle different response formats
                let allOrders = [];
                if (data.orders && Array.isArray(data.orders)) {
                    allOrders = data.orders;
                } else if (data.data && Array.isArray(data.data)) {
                    allOrders = data.data;
                } else if (Array.isArray(data)) {
                    allOrders = data;
                }

                // Filter ONLY pending orders
                const pendingOrders = allOrders.filter(order => 
                    order.status === 'pending' || order.status === 'Pending' || order.status === 'PENDING'
                );

                console.log(`Found ${pendingOrders.length} pending orders out of ${allOrders.length} total`);
                
                // Display the pending orders
                displayAvailableOrders(pendingOrders);
                
                showToast(`Found ${pendingOrders.length} available orders`, 'success');
                
            } catch (error) {
                console.error('Error fetching orders:', error);
                showToast('Failed to fetch orders: ' + error.message, 'error');
                
                document.getElementById('ordersList').innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 2rem; margin-bottom: 10px;">‚ùå</div>
                        <p>Failed to load orders</p>
                        <p style="font-size: 0.8rem; margin-top: 5px;">${error.message}</p>
                    </div>
                `;
                
            } finally {
                // Restore buttons
                if (refreshBtn) {
                    refreshBtn.innerHTML = 'üîÑ Refresh';
                    refreshBtn.disabled = false;
                }
                if (fetchBtn) {
                    fetchBtn.innerHTML = 'üîç Fetch';
                    fetchBtn.disabled = false;
                }
            }
        }

        // Display available orders in the sidebar
        function displayAvailableOrders(orders) {
            const list = document.getElementById('ordersList');
            
            if (!orders || orders.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üì≠</div>
                        <p>No pending orders available</p>
                        <p style="font-size: 0.8rem; margin-top: 5px;">Check back later</p>
                    </div>
                `;
                return;
            }

            let html = '';
            orders.forEach(order => {
                html += `
                    <div class="order-card" id="order-${order.orderId}">
                        <div class="order-header">
                            <span class="order-id">${order.orderId}</span>
                            <span class="order-status">${order.status}</span>
                        </div>
                        <div class="order-details">
                            <div class="detail-item">
                                <h4>Customer</h4>
                                <p>${order.customerName || 'Unknown'}</p>
                            </div>
                            <div class="detail-item">
                                <h4>Phone</h4>
                                <p>${order.customerPhone || 'N/A'}</p>
                            </div>
                            <div class="detail-item" style="grid-column: span 2;">
                                <h4>Pickup Address</h4>
                                <p>${order.pickupAddress || 'Address not specified'}</p>
                                ${order.pickupLocation ? `
                                    <small style="color: #6c757d; font-size: 0.7rem;">
                                        Lat: ${order.pickupLocation.latitude.toFixed(4)}, 
                                        Lng: ${order.pickupLocation.longitude.toFixed(4)}
                                    </small>
                                ` : ''}
                            </div>
                            <div class="detail-item" style="grid-column: span 2;">
                                <h4>Dropoff Address</h4>
                                <p>${order.dropoffAddress || 'Address not specified'}</p>
                                ${order.dropoffLocation ? `
                                    <small style="color: #6c757d; font-size: 0.7rem;">
                                        Lat: ${order.dropoffLocation.latitude.toFixed(4)}, 
                                        Lng: ${order.dropoffLocation.longitude.toFixed(4)}
                                    </small>
                                ` : ''}
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="acceptOrder('${order.orderId}')" style="width: 100%;">
                            ‚úÖ Accept Order
                        </button>
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        // ==================== ORDER ACTIONS ====================
        async function acceptOrder(orderId) {
            if (!riderId) {
                showToast('Please set your Rider ID first', 'error');
                return;
            }

            // Find the order from the DOM or fetch it
            try {
                showToast('Accepting order...', 'info');

                const response = await fetch(`${API_BASE_URL}/orders/${orderId}/accept`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        riderId: riderId 
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    // Fetch full order details
                    const orderRes = await fetch(`${API_BASE_URL}/orders/${orderId}`);
                    const orderData = await orderRes.json();
                    
                    currentOrder = orderData.order || orderData;
                    currentOrder.status = 'assigned';
                    
                    // Show current order
                    displayCurrentOrder(currentOrder);
                    
                    // Remove from available orders list
                    const orderElement = document.getElementById(`order-${orderId}`);
                    if (orderElement) orderElement.remove();
                    
                    showToast('Order accepted successfully!', 'success');
                    
                    // Start tracking if not already
                    if (!isTracking) {
                        toggleTracking();
                    }
                }
                
            } catch (error) {
                console.error('Accept order error:', error);
                showToast('Failed to accept order: ' + error.message, 'error');
            }
        }

        function displayCurrentOrder(order) {
            // Show current order container
            document.getElementById('currentOrderContainer').style.display = 'block';
            
            // Update order ID
            document.getElementById('currentOrderIdDisplay').textContent = order.orderId;
            
            // Build order details HTML
            const details = document.getElementById('currentOrderDetails');
            details.innerHTML = `
                <div class="current-order-details">
                    <div class="current-detail-item">
                        <h4>Customer</h4>
                        <p>${order.customerName || 'Unknown'}</p>
                    </div>
                    <div class="current-detail-item">
                        <h4>Phone</h4>
                        <p>${order.customerPhone || 'N/A'}</p>
                    </div>
                    <div class="current-detail-item" style="grid-column: span 2;">
                        <h4>Pickup Address</h4>
                        <p>${order.pickupAddress || 'Address not specified'}</p>
                    </div>
                    <div class="current-detail-item" style="grid-column: span 2;">
                        <h4>Dropoff Address</h4>
                        <p>${order.dropoffAddress || 'Address not specified'}</p>
                    </div>
                </div>
            `;
            
            // Show pickup and dropoff on map
            displayOrderOnMap(order);
            
            // Reset button states
            document.getElementById('pickupBtn').style.display = 'block';
            document.getElementById('deliverBtn').style.display = 'none';
            document.getElementById('currentOrderStatusBadge').innerHTML = 
                '<span class="status-dot"></span><span>Assigned</span>';
        }

        async function updateOrderStatus(status) {
            if (!currentOrder || !riderId) return;

            const btn = status === 'picked_up' ? document.getElementById('pickupBtn') : document.getElementById('deliverBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="btn-spinner"></span> Updating...';
            btn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/orders/${currentOrder.orderId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: status,
                        riderId: riderId
                    })
                });

                if (!response.ok) throw new Error('Failed to update status');
                
                const data = await response.json();
                
                if (data.success) {
                    currentOrder.status = status;
                    
                    if (status === 'picked_up') {
                        document.getElementById('pickupBtn').style.display = 'none';
                        document.getElementById('deliverBtn').style.display = 'block';
                        document.getElementById('currentOrderStatusBadge').innerHTML = 
                            '<span class="status-dot"></span><span>Picked Up</span>';
                        showToast('Order picked up! Head to dropoff.', 'success');
                        
                        // Show route to dropoff
                        if (currentOrder.pickupLocation && currentOrder.dropoffLocation) {
                            await calculateRoute(
                                currentOrder.pickupLocation,
                                currentOrder.dropoffLocation
                            );
                        }
                        
                    } else if (status === 'delivered') {
                        showToast('Order delivered successfully!', 'success');
                        resetOrder();
                    }
                }
                
            } catch (error) {
                console.error('Status update error:', error);
                showToast('Failed to update status', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function cancelOrder() {
            if (confirm('Are you sure you want to cancel this order?')) {
                resetOrder();
                showToast('Order cancelled', 'info');
            }
        }

        function resetOrder() {
            currentOrder = null;
            document.getElementById('currentOrderContainer').style.display = 'none';
            clearOrderFromMap();
            fetchAvailableOrders(); // Refresh the list
        }

        // ==================== MAP FUNCTIONS ====================
        function displayOrderOnMap(order) {
            clearOrderFromMap();
            
            if (order.pickupLocation) {
                pickupMarker = new maplibregl.Marker({ color: '#28a745' })
                    .setLngLat([order.pickupLocation.longitude, order.pickupLocation.latitude])
                    .setPopup(new maplibregl.Popup().setHTML('<b>üìç Pickup Location</b>'))
                    .addTo(map);
            }
            
            if (order.dropoffLocation) {
                dropoffMarker = new maplibregl.Marker({ color: '#dc3545' })
                    .setLngLat([order.dropoffLocation.longitude, order.dropoffLocation.latitude])
                    .setPopup(new maplibregl.Popup().setHTML('<b>üìå Dropoff Location</b>'))
                    .addTo(map);
            }
            
            // Route to pickup if we have current location
            if (currentLocation && order.pickupLocation) {
                calculateRoute(
                    { latitude: currentLocation.latitude, longitude: currentLocation.longitude },
                    order.pickupLocation
                );
            } else if (order.pickupLocation && order.dropoffLocation) {
                // Or show route between pickup and dropoff
                calculateRoute(
                    order.pickupLocation,
                    order.dropoffLocation
                );
            }
        }

        async function calculateRoute(start, end) {
            try {
                const response = await fetch(`${API_BASE_URL}/maps/route`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pickup: { 
                            latitude: parseFloat(start.latitude), 
                            longitude: parseFloat(start.longitude) 
                        },
                        dropoff: { 
                            latitude: parseFloat(end.latitude), 
                            longitude: parseFloat(end.longitude) 
                        }
                    })
                });

                if (!response.ok) throw new Error('Route calculation failed');
                
                const data = await response.json();
                
                let coordinates = null;
                if (data.route?.geometry?.LineString) {
                    coordinates = data.route.geometry.LineString;
                } else if (data.route?.geometry && Array.isArray(data.route.geometry)) {
                    coordinates = data.route.geometry;
                } else if (data.coordinates) {
                    coordinates = data.coordinates;
                }

                if (!coordinates || !Array.isArray(coordinates)) {
                    throw new Error('Invalid route data format');
                }

                // Draw route
                if (map.getLayer('route')) map.removeLayer('route');
                if (map.getSource('route')) map.removeSource('route');

                map.addSource('route', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: { 
                            type: 'LineString', 
                            coordinates: coordinates 
                        }
                    }
                });

                map.addLayer({
                    id: 'route',
                    type: 'line',
                    source: 'route',
                    layout: { 
                        'line-join': 'round', 
                        'line-cap': 'round' 
                    },
                    paint: { 
                        'line-color': '#667eea', 
                        'line-width': 5, 
                        'line-opacity': 0.8 
                    }
                });

                // Fit bounds
                const bounds = coordinates.reduce((b, coord) => b.extend(coord), 
                    new maplibregl.LngLatBounds(coordinates[0], coordinates[0]));
                map.fitBounds(bounds, { padding: 70, duration: 1000 });

            } catch (error) {
                console.error('Route calculation error:', error);
            }
        }

        function clearOrderFromMap() {
            if (pickupMarker) { 
                pickupMarker.remove(); 
                pickupMarker = null; 
            }
            if (dropoffMarker) { 
                dropoffMarker.remove(); 
                dropoffMarker = null; 
            }
            if (map.getLayer('route')) map.removeLayer('route');
            if (map.getSource('route')) map.removeSource('route');
        }

        // ==================== LOCATION TRACKING ====================
        function toggleTracking() {
            if (isTracking) {
                stopTracking();
            } else {
                startTracking();
            }
        }

        function startTracking() {
            if (!navigator.geolocation) {
                showToast('Geolocation is not supported by your browser', 'error');
                return;
            }

            isTracking = true;
            
            locationWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    currentLocation = { latitude, longitude };
                    
                    if (riderMarker) {
                        riderMarker.setLngLat([longitude, latitude]);
                    } else {
                        addRiderMarker(latitude, longitude);
                    }
                    
                    // Send location to server if we have an active order
                    if (currentOrder) {
                        updateLocation(latitude, longitude);
                    }
                },
                (error) => {
                    console.error('Geolocation error:', error.message);
                },
                { 
                    enableHighAccuracy: true, 
                    maximumAge: 10000, 
                    timeout: 5000 
                }
            );
            
            // Update UI
            document.getElementById('trackingBtn').innerHTML = '<span>üì°</span> Online';
            document.getElementById('trackingBtn').classList.add('active');
            document.getElementById('trackingStatusIndicator').style.background = '#28a745';
            document.getElementById('trackingStatusText').innerHTML = 'Status: <strong>Online - Tracking Active</strong>';
            document.getElementById('riderStatusBadge').className = 'status-badge status-online';
            document.getElementById('riderStatusBadge').innerHTML = 
                '<span class="status-dot"></span><span>Online</span>';
            
            showToast('Location tracking started', 'success');
        }

        function stopTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            
            isTracking = false;
            
            document.getElementById('trackingBtn').innerHTML = '<span>üì°</span> Go Online';
            document.getElementById('trackingBtn').classList.remove('active');
            document.getElementById('trackingStatusIndicator').style.background = '#dc3545';
            document.getElementById('trackingStatusText').innerHTML = 'Status: <strong>Offline</strong>';
            document.getElementById('riderStatusBadge').className = 'status-badge status-offline';
            document.getElementById('riderStatusBadge').innerHTML = 
                '<span class="status-dot"></span><span>Offline</span>';
            
            showToast('Location tracking stopped', 'info');
        }

        async function updateLocation(latitude, longitude) {
            if (!riderId || !currentOrder) return;
            
            try {
                await fetch(`${API_BASE_URL}/rider/location`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        riderId: riderId,
                        orderId: currentOrder.orderId,
                        latitude: parseFloat(latitude),
                        longitude: parseFloat(longitude),
                        isTracking: true
                    })
                });
            } catch (error) {
                console.error('Location update error:', error);
            }
        }

        function centerOnLocation() {
            if (currentLocation) {
                map.setCenter([currentLocation.longitude, currentLocation.latitude]);
                map.setZoom(15);
                showToast('Map centered on your location', 'info');
            } else {
                showToast('Location not available', 'error');
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            
            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'error') icon = '‚ùå';
            if (type === 'warning') icon = '‚ö†Ô∏è';
            
            toast.innerHTML = `${icon} ${message}`;
            toast.className = 'toast';
            toast.classList.add(`toast-${type}`);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => toast.classList.remove('show'), 3500);
        }
    </script>
</body>
</html>